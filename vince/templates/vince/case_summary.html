{% load i18n humanize ticket_to_link %}
{{ case_tags|json_script:"case_tags" }}
{{ case_available_tags|json_script:"case_available_tags" }}
<div class="case-container" caseid="{{ case.id }}">
  <ul class="tabs" data-tabs id="case-tabs" data-deep-link="true" data-update-history="true">
    <li class="tabs-title"><a href="#details" data-tabs-target="details"> <i class="fas fa-folder-open"></i> Details</a></li>
    {% if cr %}
    <li class="tabs-title"><a data-tabs-target="cr" href="#cr" class="asyncclick" data-divid="cr"><i class="fas fa-info-circle"></i> Original Report</a></li>
    {% elif ticket %}
    <li class="tabs-title"><a data-tabs-target="ticket" href="#ticket"><i class="fas fa-info-circle"></i> Ticket</a></li>
    {% else %}
    <li class="tabs-title"><a data-tabs-target="noticketorcr" href="#noticketorcr" class="asyncclick" data-divid="noticketorcr"><i class="fas fa-info-circle"></i> Original Report</a></li>
    {% endif %}
    <li class="tabs-title is-active"><a aria-selected="true" data-tabs-target="tasks" href="#tasks"><i class="fas fa-list-alt"></i> Tasks</a></li>
    <li class="tabs-title"><a data-tabs-target="vuls" href="#vuls" class="asyncclick" data-divid="vuls"><i class="fas fa-skull"></i> Vuls</a></li>
    <li class="tabs-title" id="vendors-li"><a data-tabs-target="vendors" href="#vendors"><i class="fas fa-users"></i> Vendors</a></li>
    <li class="tabs-title"><a data-tabs-target="posts" href="#posts" class="asyncclick" data-divid="posts"><i class="fas fa-sticky-note"></i> Posts</a></li>
    <li class="tabs-title"><a data-tabs-target="vulnote" href="#vulnote" class="asyncclick" data-divid="vulnote"><i class="fas fa-bookmark"></i> Vul Note</a></li>
    <li class="tabs-title"><a data-tabs-target="participants" href="#participants" class="asyncclick" data-divid="participants"><i class="fas fa-users"></i> Participants</a></li>
  </ul>
  <div class="tabs-content" data-tabs-content="case-tabs">
    <div class="tabs-panel" id="details">
      <a href="{% url 'vince:editcase' case.id %}"><button class="button cmu tiny"><i class="fas fa-edit"></i> Edit Case Details </button></a>
      <a id="mutecase" href="{% url 'vince:mutecase' case.id %}" class="button cmu primary tiny" href="#" title="{% trans 'Mute case reminders. Do not remind me about this case' %}"><i class="fas fa-volume-mute"></i> Mute Reminders</a>
      <table class="hover unstriped fixed">
	<tbody>
		<tr><th width="200">{% trans "Title" %}</th>
            <td><b>{{ case.title }}</b></td>
          </tr>
	  {% if case.team_owner %}
          <tr><th width="200">{% trans "Owner" %}</th>
            <td><b>{{ case.team_owner.name }}</b>  <button id="transfer" href="{% url 'vince:reqtransfer' case.id %}" class="button tiny assignme">Request Transfer</button></td>
          </tr>
	  {% else %}
	  <tr><th width="200">{% trans "Owner" %}</th>
            <td>No Owner Set  <button href="{% url 'vince:reqtransfer' case.id %}" class="button tiny assignme" id="transfer">Request Transfer</button></td>
          </tr>
	  {% endif %}
	  <tr><th width="200">{% trans "Status" %}</th>
	    <td>{% if case.lotus_notes %}{% else %}<a href="{% url 'vinny:vincase' case.id %}" target="_blank"><span class="label primary">VINCEComm</span></a>  {% endif %}{% if case.status == 1 %}<span class="label success">Active</span>{% else %}<span class="label info">Inactive</span>{% endif %}  <a href="{% url 'vince:updateconfirm' case.id %}" id="changestatus"><i class="fas fa-edit"></i></a></td>
	  </tr>
	  <tr><th>{% trans "Public" %}</th><td>{% if case.publicdate %}<span class="label success">Public</span>  <span class="dateprinted" title="Click toggle formats">{{ case.publicdate|date:"Y-m-d H:i:sO" }}</span> {% if case.publicurl %}<a class="publicurl" href="{{case.publicurl}}" target="_blank"><i class="fas fa-external-link-alt"></i> {{ case.publicurl|smarter_urlize:50 }}</a>{% endif %}{% else %}<span class="label warning">Not Public</span>{% endif %}</td>
	  </tr>
	  <tr><th>{% trans "Date Created" %}</th><td> <span class="dateprinted" title="Click toggle formats">{{ case.created|date:"Y-m-d H:i:sO" }}</span></td>
	  </tr>
	  <tr>
	    <th>{% trans "Estimated Date Public" %}</th>
	    <td><span class="dateprinted" title="Click toggle formats">{{ case.due_date|date:"Y-m-d H:i:sO" }}</span> ({{ case.due_date|naturaltime }})</td>
          </tr>
	    {% if case.published %}
	  <tr><th width="200">{% trans "Published" %}</th>
	    <td><span class="label badge-tag-success">Published</span>  <span class="dateprinted" title="Click toggle formats">{{ vulnote.date_published|date:"Y-m-d H:i:sO" }}</span>: <a href="{% url 'vincepub:vudetail' case.vuid %}" target="_blank" rel="noopener">View Vulnerability Note</a></td>
	  </tr>
	  {% endif %}
	  <tr><th>{% trans "Case Permissions" %}</th>
	    <td>{% for p in case.casepermissions_set.all %}<span class="label secondary">{{ p.group.name }}  {% if p.group_read %}r{% endif %}{% if p.group_write %}/w{% endif %}{% if p.publish %}/p {% endif %}</span>{% endfor %}</td>
	  </tr>
	  <tr><th width="200">{% trans "Summary" %}</th>
	    <td>{{ case.summary }}</td>
	  </tr>
	  <tr><th>{% trans "Product Name" %}</th>
	    <td>{{ case.product_name }}</td>
	  <tr>
	  <tr><th>{% trans "Product Version" %}</th>
	    <td>{{ case.product_version }}</td>
	  </tr>
	  <tr>
	    <th>{% trans "Assigned To" %}</th>
	    <td><div href="{% url 'vince:taguser' case.id %}" class="taggle_input custom martie" id="user_taggs"></div></td>
          </tr>
          <tr>
	    <th>{% trans "Case Tags" %}</th>
	    <td><div href="{% url 'vince:updatecase' case.id %}" class="taggle_input custom martie" id="case_taggs"></div>
	    </td>
	  </tr>
	  <tr>
	    <th>{% trans "Dependencies" %} <a class="adddep assignme button primary tiny" action="{% url 'vince:addcasedep' case.id %}" title="{% trans "Add dependency to make this case dependent on another ticket. A case may not be closed until all tickets it depends on are closed." %}"><i class="fas fa-plus"></i></a></th>
            <td>{% for dep in case.casedependency.all %}
	      {% if forloop.first %}<p>{% trans "This ticket cannot be resolved until the following ticket(s) are resolved" %}</p><ul>{% endif %}
		<li><a href='{{ dep.depends_on.get_absolute_url }}'>{{ dep.depends_on.ticket }} {{ dep.depends_on.title }}</a> ({{ dep.depends_on.get_status_display }}) <a title="{% trans 'Remove Dependency' %}"  href='{% url 'vince:rmcasedep' case.id dep.id %}' class="rmdep"><i class="fas fa-trash"></i></a></li>
		{% if forloop.last %}</ul>{% endif %}
              {% empty %}
              <p>{% trans "This case has no dependencies." %}</p>
              {% endfor %}
	    </td>
	  </tr>
	  <tr>
	    <div class="reveal" id="modal" data-reveal></div>
	    <th>{% trans "Reminders" %} <a id="newremind" class="assignme button primary tiny" href="{% url 'vince:newreminder' %}?case={{case.vuid}}" title="{% trans 'Add a reminder for this case' %}"><i class="fas fa-plus"></i></a>

	    </th>
	    <td><ul>{% for r in reminders %}
		<li><i><span class="dateprinted" title="Click toggle formats">{{r.alert_date|date:"Y-m-d H:i:sO"}}</span></i> "{{ r }}" <small><b>for {{r.user.usersettings.preferred_username}}</b></small><a class="rmreminder" id="{{ r.id }}" action="{% url 'vince:rmreminder' %}">   <i class="fas fa-trash"></i></a></li>
	      {% empty %}
              <p>{% trans "This case has no reminders." %}</p>
              {% endfor %}</ul>

	    </td>
	  </tr>
	</tbody>
      </table>
    </div>
    {% if cr %}
	<div class="tabs-panel asynchronized" id="cr" href="{% url 'vince:caseoriginalreporttab' case.id %}">
		<!-- async click loader -->
	</div>
    {% elif ticket %}
    <div class="tabs-panel" id="ticket">
      {% include 'vince/ticket_table.html' with table_class="hover fixed unstriped" %}
    </div>
    {% else %}
	<div class="tabs-panel asynchronized" id="noticketorcr" href="{% url 'vince:casenoticketorreporttab' case.id %}">
		<!-- async click loader -->
	</div>
    {% endif %}
    <div class="reveal large" id="largemodal" data-reveal data-close-on-click='false'></div>
    <div class="reveal small" id="smallmodal" data-reveal data-close-on-click='false'></div>
    <div class="tabs-panel asynchronized" id="vuls" href="{% url 'vince:casevulstab' case.id %}">
		<!-- async click loader -->
	</div>
    
    <div class="hidden" id="task_assign">
      <div class="reassign">
	<select class="task_reassign">
          {% for user in assignable_users %}
          <option value="{{ user.id }}">{{ user.usersettings.vince_username }}</option>
          {% endfor %}
          <option value="0">Unassign</option>
	</select><button type="button" class="task_assign_submit"><i class="fas fa-check"></i>
	</button><button type="button" class="task_assign_cancel"><i class="fas fa-times"></i></button>
      </div>
    </div>
    
    <div class="tabs-panel is-active" id="tasks">
      <div class="row">
	<div class="large-2 columns">
	  <a href="{% url 'vince:newticket' case.id %}"><button class="button cmu tiny"> <i class="fas fa-plus"></i> Add Task </button></a>
	</div>
	<div class="large-1 columns"></div>
	<div class="large-3 columns">
	  <div class="input-group">
	    <span class="input-group-label">Status</span>
	    <select class="input-group-field" id="filterstatus">
	      <option value="0">All</option>
	      <option value="1">Open</option>
	      <option value="4">Closed</option>
	    </select>
	  </div>
	</div>
	
	<div class="large-6 columns">
	  <div class="input-group">
	    <input class="input-group-field" type="text" placeholder="Filter tasks" id="filter_tasks" href="{% url 'vince:casefiltertask' case.id %}">
	    <div class="input-group-button">
	      <button type="submit" class="button"><i class="fas fa-search"></i></button>  
	    </div>
	  </div>
	</div>
      </div>
      {{ assignable_usersjs|json_script:"user_data"}}
      <div id="case_tasks" class="tabulator bootstrap">
      </div>
    </div>

    <div class="tabs-panel" id="vendors">
		<!-- Link to open the modal -->
		<div class="row">
	  <div class="large-9 medium-12 small-12 columns">
		<button class="button cmu tiny" id="addnewvendor" href="{% url 'vince:addvendor' %}"> <i class="fas fa-plus"></i> Add Vendor </button>
		<!--<a href="{% url 'vince:editvendorlist' case.id %}"><button class="button cmu tiny"><i class="fas fa-pencil-alt"></i> Edit Vendor</button></a>-->
		<button class="button cmu tiny" id="select-page"> Select Page </button>
		<button class="button cmu tiny" id="select-all-vendors"> Select All </button>
		<button class="button cmu tiny" id="deselect-all-vendors"> Deselect All </button>
		<button class="button cmu tiny" id="remove-vendor"> <i class="fas fa-trash"></i> Remove Vendor </button>
		<a href="{% url 'vince:approveall' case.id %}" id="approveall" class="button cmu tiny"><i class="fas fa-check"></i> Approve all</a>
		{% if case.lotus_notes %}
		{% else %}
		<a href="#" class="button cmu tiny" id="notifyvendors"><i class="fas fa-paper-plane"></i> Send Notifications</a>
		{% endif %}
		{% if case.lotus_notes %}{% else %}
		<a class="button cmu tiny" href="{% url 'vinny:groupchatcase' vc_case.id %}">Start Group Thread</a>
		{% endif %}
	  </div>
	  <div class="large-9 medium-12 small-12 columns" id="selected_count"></div>
	  <div class="large-3 small-12 medium-12 columns large-text-right">
		{% if vendorgroups %}
		{% for g in vendorgroups %}
		<span title="Group added to case" class="label"><a href="{% url 'vince:group' g.from_group.id %}">{{ g.from_group.name }}</a></span>
		{% endfor %}
		{% endif %}
	  </div>
		</div>
	  <div class="reveal" id="statusmodal" data-reveal data-close-on-click="false"></div>	  
		<div id="vendorlist">
	  {% if vendors %}
	  {% include 'vince/casevendors.html' %}
	  {% endif %}
		</div>
		{{ vendorsjs|json_script:"vendors_data" }}
		<div id="vendors-table" class="tabulator bootstrap"></div>
	  </div>

    <div class="tabs-panel asynchronized" id="posts" href="{% url 'vince:casepoststab' case.id %}">
      <!-- async click loader -->
    </div>
    
	<div class="tabs-panel asynchronized" id="vulnote" href="{% url 'vince:casevulnotetab' case.id %}">
	  <!-- async click loader -->
	</div>

    <div id="approvenote" class="reveal" data-reveal data-close-on-click='false'></div>

	<div class="tabs-panel asynchronized" id="participants" href="{% url 'vince:caseparticipantstab' case.id %}">
		<!-- async click loader -->
	  </div>
  </div>
</div>

